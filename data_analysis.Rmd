---
title: "Data Analysis"
author: "Christian Hobelsberger"
date: '`r Sys.Date()`'
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(gridExtra)

# Read tables from data_analysis_prep_tables.R
table_Obs_D1_Date <- readRDS(file = "tables/analysis/table_Obs_D1_Date.RDS")
table_NA_D1_Date <- readRDS(file = "tables/analysis/table_NA_D1_Date.RDS")
table_Obs_D2_Date <- readRDS(file = "tables/analysis/table_Obs_D2_Date.RDS")
table_NA_D2_Date <- readRDS(file = "tables/analysis/table_NA_D2_Date.RDS")
table_Obs_D4_Date <- readRDS(file = "tables/analysis/table_Obs_D4_Date.RDS")
table_NA_D4_Date <- readRDS(file = "tables/analysis/table_NA_D4_Date.RDS")
table_Obs_D5_Date <- readRDS(file = "tables/analysis/table_Obs_D5_Date.RDS")
table_NA_D5_Date <- readRDS(file = "tables/analysis/table_NA_D5_Date.RDS")
table_Obs_region_agg_Date_weekly <- readRDS(file = "tables/analysis/table_Obs_region_agg_Date_weekly.RDS")
```

## Analysis of Corona data from Germany

```{r Analysis of Corona data from Germany}
bl_massnahmen_index_tag <- readRDS(file = "data/protected_data/bl_massnahmen_index_tag.RDS")

unique(bl_massnahmen_index_tag$bundesland)

# Plot: German restriction index over time by federal state 
ggplot(data = bl_massnahmen_index_tag, mapping = aes(x = datum, y = bl_mn_idx_t, color = bundesland)) +
  geom_line(alpha = .5)  +
  labs(title = "German measures index over time by federal states",
       x = "Date",
       y = "Measures index federal states per day (in %)")
ggsave(filename = "Plots/german_restrictions/measures_date.png", width = 12, height = 9)
  

# Plot: German restriction index over time for Bavaria 
ggplot(data = filter(bl_massnahmen_index_tag, bundesland == "Bayern"), 
       mapping = aes(x = datum, y = bl_mn_idx_t)) +
  geom_line()  +
  labs(title = "German measures index over time for Bavaria",
       x = "Date",
       y = "Measures index federal states per day (in %)")
ggsave(filename = "Plots/german_restrictions/measures_date_bavaria.png", width = 12, height = 9)

# Plot: German restriction index (Daycare centers) over time by federal state 
ggplot(data = bl_massnahmen_index_tag, mapping = aes(x = datum, y = bl_mn_idx_t_m03, color = bundesland)) +
  geom_line(alpha = .5)  +
  labs(title = "German measures index (Daycare centers) over time by federal states",
       x = "Date",
       y = "Measures index (Daycare centers) federal states per day (in %)")
ggsave(filename = "Plots/german_restrictions/measures_daycare_date.png", width = 12, height = 9)

# Plot: German restriction index (Secondary schools) over time by federal state 
ggplot(data = bl_massnahmen_index_tag, mapping = aes(x = datum, y = bl_mn_idx_t_m02a, color = bundesland)) +
  geom_line(alpha = .5)  +
  labs(title = "German measures index (Secondary schools) over time by federal states",
       x = "Date",
       y = "Measures index (Secondary schools) federal states per day (in %)")
ggsave(filename = "Plots/german_restrictions/measures_sec_schools_date.png", width = 12, height = 9)

# Plot: German restriction index (Elementary schools) over time by federal state 
ggplot(data = bl_massnahmen_index_tag, mapping = aes(x = datum, y = bl_mn_idx_t_m02b, color = bundesland)) +
  geom_line(alpha = .5)  +
  labs(title = "German measures index (Elementary schools) over time by federal states",
       x = "Date",
       y = "Measures index (Elementary schools) federal states per day (in %)")
ggsave(filename = "Plots/german_restrictions/measures_elem_schools_date.png", width = 12, height = 9)

# Plot: German restriction index (Mask obligation) over time by federal state 
ggplot(data = bl_massnahmen_index_tag, mapping = aes(x = datum, y = bl_mn_idx_t_m16, color = bundesland)) +
  geom_line(alpha = .5)  +
  labs(title = "German measures index (Mask obligation) over time by federal states",
       x = "Date",
       y = "Measures index (Mask obligation) federal states per day (in %)")
ggsave(filename = "Plots/german_restrictions/measures_maks_date.png", width = 12, height = 9)
```

## Analysis of macrodata with restriction data

```{r Analysis of macrodata with restriction data}
# Read macrodata with restriction data
macro_restr <- readRDS(file = "data/protected_data/macro_restr.RDS")

# Plot: German restriction index vs. anxious_7d
ggplot(data = macro_restr, mapping = aes(x = bl_mn_idx_t, y = anxious_7d)) +
  geom_point(alpha = .1) +
  labs(title = "German restriction index vs. anxious_7d",
       x = "Measures index federal states per day (in %)",
       y = "anxious_7d")
ggsave(filename = "Plots/macro_restrictions/measures_anxious7d.png", width = 12, height = 9)

# Plot: German restriction index vs. depressed_7d
ggplot(data = macro_restr, mapping = aes(x = bl_mn_idx_t, y = depressed_7d)) +
  geom_point(alpha = .1) +
  labs(title = "German restriction index vs. depressed_7d",
       x = "Measures index federal states per day (in %)",
       y = "depressed_7d")
ggsave(filename = "Plots/macro_restrictions/measures_depressed_7d.png", width = 12, height = 9)

# Plot: German restriction index vs. depressed_7d SMOOTHED
ggplot(data = macro_restr, mapping = aes(x = bl_mn_idx_t, y = depressed_7d)) +
  geom_point(alpha = .1) +
  geom_smooth() +
  labs(title = "German restriction index vs. depressed_7d",
       x = "Measures index federal states per day (in %)",
       y = "depressed_7d")
ggsave(filename = "Plots/macro_restrictions/measures_depressed_7d_smoothed.png", width = 12, height = 9)

# Plot: German restriction index vs. worried_become_ill
ggplot(data = macro_restr, mapping = aes(x = bl_mn_idx_t, y = worried_become_ill)) +
  geom_point(alpha = .1) +
  labs(title = "German restriction index vs. worried_become_ill",
       x = "Measures index federal states per day (in %)",
       y = "worried_become_ill")
ggsave(filename = "Plots/macro_restrictions/measures_worried_become_ill.png", width = 12, height = 9)

# Plot: German restriction index vs. finance
ggplot(data = macro_restr, mapping = aes(x = bl_mn_idx_t, y = finance)) +
  geom_point(alpha = .1) +
  labs(title = "German restriction index vs. finance",
       x = "Measures index federal states per day (in %)",
       y = "finance")
ggsave(filename = "Plots/macro_restrictions/measures_finance.png", width = 12, height = 9)

# Plot: German restriction index vs. food_security
ggplot(data = macro_restr, mapping = aes(x = bl_mn_idx_t, y = food_security)) +
  geom_point(alpha = .1) +
  labs(title = "German restriction index vs. food_security",
       x = "Measures index federal states per day (in %)",
       y = "food_security")
ggsave(filename = "Plots/macro_restrictions/food_security.png", width = 12, height = 9)

```

# Analysis of microdata
```{r general analysis of microdata}
# Read in microdata
CTIS_microdata <- readRDS(file = "data/protected_data/CTIS_microdata.RDS")


# Testing -----------------------------------------------------------------------------------------------------

# Spearman rank correlation coefficient of D1, D2: 0.6060078
cor(as.numeric(CTIS_microdata$D1), as.numeric(CTIS_microdata$D2), use="pairwise.complete.obs", method = "spearman")

# Save the crosstable of D1 and D2 as a PDF file
cross_table_D1_D2 <- table(CTIS_microdata$D1, CTIS_microdata$D2)
pdf("tables/cross_tables/cross_table_D1_D2.pdf", height=4, width=10)
grid.table(cross_table_D1_D2)
dev.off()


# Plots with table data: 

## Plot Observations and NAs ----------------------------------------------------------------------------------

# Plot: Observations D1 (anxious) over time
ggplot(data = table_Obs_D1_Date, mapping = aes(x = RecordedDate, y = count)) +
  geom_line() +
  labs(title = "Observations D1 (anxious) over time",
       x = "Date",
       y = "Number of Observations - D1 (per day)")
ggsave("Plots/microdata/Obs_RecordedDate_D1_lineplot.png", width = 12, height = 6)

# Plot: NAs D1 (anxious) over time
ggplot(data = table_NA_D1_Date, mapping = aes(x = RecordedDate, y = count_NA)) +
  geom_line() +
  labs(title = "NAs D1 (anxious) over time",
       x = "Date",
       y = "Number of NAs - D1 (per day)")
ggsave("Plots/microdata/NAs_RecordedDate_D1_lineplot.png", width = 12, height = 6)

# Plot: Weekly observations of region_agg (federal state) over time
ggplot(data = table_Obs_region_agg_Date_weekly, mapping = aes(x = Date, y = count, color = region_agg)) +
  geom_line() +
  labs(title = "Weekly observations of region_agg (federal state) over time",
       x = "Date",
       y = "Number of weekly observations - region_agg (federal state)") +
  guides(color=guide_legend(title="region_agg (federal state)"))
ggsave("Plots/microdata/Obs_Date_region_agg_weekly_lineplot.png", width = 12, height = 6)




# Plots without table data:


# Plot: Observations region_agg (federal state)
ggplot(data = CTIS_microdata, mapping = aes(x = region_agg)) +
  geom_bar() +
  coord_flip() +
  labs(title = "Observations region_agg (federal state)",
       x = "Number of Observations",
       y = "federal states")
ggsave("Plots/microdata/Obs_region_agg_barplot.png", width = 12, height = 6)
```

# Analysis of microdata with restriction data
```{r Analysis of microdata with restriction data}
# Read microdata with restriction data
micro_restr <- readRDS(file = "data/protected_data/micro_restr.RDS")

# German restriction index -------------------------------------------------------

# Plot: D1 vs German restriction index
ggplot(data = micro_restr %>% select(D1, bl_mn_idx_t) %>% drop_na(), 
       mapping = aes(x = D1, y = bl_mn_idx_t)) +
  geom_boxplot() +
  labs(title = "D1 (anxious) vs. German restriction index",
       x = "D1 (anxious)",
       y = "Measures index federal states per day (in %)")
ggsave("Plots/micro_restrictions/D1_restr_boxplot.png", width = 12, height = 9)

# Plot: D1 vs German restriction index vs E4
ggplot(data = micro_restr %>% select(D1, E4, bl_mn_idx_t) %>% drop_na(), 
       mapping = aes(x = D1, y = bl_mn_idx_t, color = E4)) +
    geom_boxplot() +
    labs(title = "D1 (anxious) vs. German restriction index vs. age group",
         x = "D1 (anxious)",
         y = "Measures index federal states per day (in %)") + 
    scale_color_brewer(palette = "Blues", name = "E4 (age group)")
ggsave("Plots/micro_restrictions/D1_restr_E4_boxplot.png", width = 12, height = 6)

# Plot: D1 vs German restriction index vs E8
ggplot(data = micro_restr %>% select(D1, E8, bl_mn_idx_t) %>% drop_na(), 
       mapping = aes(x = D1, y = bl_mn_idx_t, color = E8)) +
    geom_boxplot() +
    labs(title = "D1 (anxious) vs. German restriction index vs. education-level",
         x = "D1 (anxious)",
         y = "Measures index federal states per day (in %)") + 
    scale_color_brewer(palette = "Blues", name = "E8 (education-level)")
ggsave("Plots/micro_restrictions/D1_restr_E8_boxplot.png", width = 12, height = 5)

# Plot: D1 vs German restriction index vs E2
ggplot(data = micro_restr %>% select(D1, E2, bl_mn_idx_t) %>% drop_na(), 
       mapping = aes(x = D1, y = bl_mn_idx_t, color = E2)) +
    geom_boxplot() +
    labs(title = "D1 (anxious) vs. German restriction index vs. area of living",
         x = "D1 (anxious)",
         y = "Measures index federal states per day (in %)") + 
    scale_color_brewer(palette = "Dark2", name = "E2 (area of living)")
ggsave("Plots/micro_restrictions/D1_restr_E2_boxplot.png", width = 12, height = 6)

# Plot: D1 vs German restriction index vs E3
ggplot(data = micro_restr %>% select(D1, E3, bl_mn_idx_t) %>% drop_na(), 
       mapping = aes(x = D1, y = bl_mn_idx_t, color = E3)) +
    geom_boxplot() +
    labs(title = "D1 (anxious) vs. German restriction index vs. gender",
         x = "D1 (anxious)",
         y = "Measures index federal states per day (in %)") + 
    scale_color_brewer(palette = "Dark2", name = "E3 (gender)")
ggsave("Plots/micro_restrictions/D1_restr_E3_boxplot.png", width = 12, height = 6)

# Plot: G1 vs German restriction index
ggplot(data = micro_restr %>% select(G1, bl_mn_idx_t) %>% drop_na(), 
       mapping = aes(x = G1, y = bl_mn_idx_t)) +
  geom_boxplot() +
  labs(title = "G1 (worried catching covid) vs. German restriction index",
       x = "G1 (worried catching covid)",
       y = "Measures index federal states per day (in %)")
ggsave("Plots/micro_restrictions/G1_restr_boxplot.png", width = 12, height = 9)

# German restriction index (Mask obligation) -------------------------------------------------------

# Plot: D1 vs German restriction index (Mask obligation) vs E4
ggplot(data = micro_restr %>% select(D1, E4, bl_mn_idx_t_m16) %>% drop_na(), 
       mapping = aes(x = D1, y = bl_mn_idx_t_m16, color = E4)) +
    geom_boxplot() +
    labs(title = "D1 (anxious) vs. German restriction index (Mask obligation) vs. age group",
         x = "D1 (anxious)",
         y = "Measures index (Mask obligation) federal states per day (in %)") + 
    scale_color_brewer(palette = "Blues", name = "E4 (age group)")
ggsave("Plots/micro_restrictions/D1_restr_masks_E4_boxplot.png", width = 12, height = 6)
```

